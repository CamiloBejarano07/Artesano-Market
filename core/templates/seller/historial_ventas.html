{% load static %}
{% load currency_tags %}
{%load tz %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historial de ventas - Artesano</title>
  <link rel="stylesheet" href="{% static 'css/historial.css' %}">
  <link rel="icon" type="image/png" sizes="48x48" href="{% static 'images/icono_artesano.png' %}" />
  <style>
    /* Estilos adicionales específicos para historial de ventas del vendedor */
    .seller-historial-header {
      margin-bottom: 30px;
      text-align: center;
    }

    .seller-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
      margin-top: 20px;
    }

    .stat-box {
      background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    }

    .stat-box h3 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.9;
    }

    .stat-box .stat-value {
      font-size: 28px;
      font-weight: bold;
      margin-top: 10px;
    }

    .no-sales {
      text-align: center;
      padding: 40px;
      background-color: #ECF0F1;
      border-radius: 10px;
      color: #7F8C8D;
    }

    .no-sales p {
      font-size: 18px;
      margin: 20px 0;
    }

    .no-sales a {
      display: inline-block;
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #F39C12;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    .no-sales a:hover {
      background-color: #D35400;
    }

    .sale-card {
      background-color: #ECF0F1;
      border-radius: 10px;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      text-align: left;
    }

    .sale-card:hover {
      transform: scale(1.02);
      box-shadow: 0px 6px 15px rgba(0, 0, 0, 0.15);
    }

    .sale-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .sale-top h3 {
      font-size: 18px;
      color: #2C3E50;
      margin: 0;
    }

    .sale-status {
      font-size: 12px;
      font-weight: 600;
      color: #F39C12;
      background-color: #FFF3CD;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .sale-body {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .sale-image-wrap {
      flex-shrink: 0;
    }

    .sale-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 5px;
    }

    .sale-info {
      flex: 1;
    }

    .sale-info p {
      margin: 5px 0;
      color: #7F8C8D;
      font-size: 13px;
    }

    .sale-info p strong {
      color: #2C3E50;
    }

    .sale-price-highlight {
      color: #F39C12;
      font-weight: 600;
      font-size: 16px;
    }

    .btn-expandir {
      background-color: #34495E;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.3s ease, transform 0.3s ease;
      margin-top: 10px;
    }

    .btn-expandir:hover {
      background-color: #2C3E50;
      transform: scale(1.05);
    }

    .btn-enviar {
      background-color: #27AE60;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.3s ease;
      display: inline-block;
    }

    .btn-enviar:hover:not(:disabled) {
      background-color: #229954;
      transform: scale(1.05);
    }

    .btn-enviar:disabled {
      background-color: #BDC3C7;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .sale-details {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #BDC3C7;
    }

    .sale-details h4 {
      font-size: 16px;
      color: #34495E;
      margin-bottom: 10px;
    }

    .details-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #D5DBDB;
      font-size: 13px;
    }

    .details-row:last-child {
      border-bottom: none;
    }

    .details-label {
      color: #7F8C8D;
      font-weight: 500;
    }

    .details-value {
      color: #2C3E50;
      font-weight: 600;
    }

    .sales-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 80px;
      justify-items: center;
    }
  </style>
</head>

<body>

<header id="Header">
  <img class="logo" src="{% static 'images/logo_artesano.png' %}" alt="Logo Artesano">

  <nav class="navegacion">
    <a href="{% url 'dashboard_seller' %}">Inicio</a>
    <a href="{% url 'help' %}">Contactanos</a>
    <a href="{% url 'seller_settings' %}">Configuración</a>

    {% if user_logged %}
      <form id="logout-form" action="{% url 'auth_logout' %}" method="post" style="display:none;">{% csrf_token %}</form>
      <a href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">Cerrar Sesión</a>
    {% else %}
      <a href="{% url 'login' %}">Iniciar Sesión</a>
    {% endif %}
  </nav>
</header>


<main class="container">

  <div class="seller-historial-header">
    <h1>Historial de Ventas</h1>
    <p style="color: #7F8C8D; font-size: 16px;">Resumen de todas las ventas de tus productos</p>
  </div>

  <!-- MENSAJES DE NOTIFICACIÓN DE ENVÍO -->
  {% if messages %}
    {% for message in messages %}
      {% if 'shipping_notification' in message.tags %}
        <div style="background-color: #D5F4E6; border: 1px solid #27AE60; color: #27AE60; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 20px;"></span>
          <strong>{{ message }}</strong>
        </div>
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if ventas %}
    <!-- Estadísticas -->
    <div class="seller-stats">
      <div class="stat-box">
        <h3>Total de Ventas</h3>
        <div class="stat-value">{{ total_ventas }}</div>
      </div>
      <div class="stat-box">
        <h3>Unidades Vendidas</h3>
        <div class="stat-value">{{ total_unidades }}</div>
      </div>
      <div class="stat-box">
        <h3>Ingresos Totales</h3>
        <div class="stat-value">{{ total_ingresos|format_cop }}</div>
      </div>
    </div>

    <!-- Grid de ventas -->
    <div class="sales-grid">

      {% for venta in ventas %}
        <div class="sale-card">

          <div class="sale-top">
            <h3>{{ venta.producto_nombre }}</h3>
            <span class="sale-status">{{ venta.estado }}</span>
          </div>

          <div class="sale-body">

            <div class="sale-image-wrap">
              {% if venta.imagen %}
                <img src="{{ MEDIA_URL }}{{ venta.imagen }}" class="sale-image" alt="{{ venta.producto_nombre }}">
              {% else %}
                <img src="{% static 'images/default_product.png' %}" class="sale-image" alt="Sin imagen">
              {% endif %}
            </div>

            <div class="sale-info">
              <p><strong>Cliente:</strong> {{ venta.cliente_nombre }}</p>
              <p><strong>Cantidad:</strong> {{ venta.cantidad }} unidad{% if venta.cantidad != 1 %}es{% endif %}</p>
              <p><strong>Precio unitario:</strong> <span class="sale-price-highlight">{{ venta.producto_precio|format_cop }}</span></p>
              <p><strong>Fecha:</strong> {{ venta.fecha_venta_formateada }}</p>
              <p><strong>Subtotal:</strong> <span class="sale-price-highlight">{{ venta.subtotal|format_cop }}</span></p>
              <button class="btn-expandir" data-sale="{{ forloop.counter0 }}">
                Ver detalles
              </button>
            </div>

          </div>

          <div class="sale-details" id="details-{{ forloop.counter0 }}" style="display:none;">
            <h4>Información de la venta</h4>
            <div class="details-row">
              <span class="details-label">Método de pago:</span>
              <span class="details-value">{{ venta.metodo_pago }}</span>
            </div>
            <div class="details-row">
              <span class="details-label">Estado del pago:</span>
              <span class="details-value">Completada</span>
            </div>
            <div class="details-row">
              <span class="details-label">Estado de envío:</span>
              <span class="details-value">
                {% if venta.estado == 'Enviado' %}
                  <span style="color: #27AE60; font-weight: bold;">Enviado ✓</span>
                  <button class="btn-enviar" disabled style="margin-left: 10px; opacity: 0.6; cursor: not-allowed;">Enviado</button>
                {% else %}
                  <span style="color: #F39C12; font-weight: bold;">Sin enviar</span>
                  <a href="{% url 'marcar_pedido_enviado' venta.id_venta %}" class="btn-enviar" style="margin-left: 10px; text-decoration: none; display: inline-block;">Enviar</a>
                {% endif %}
              </span>
            </div>
            <div class="details-row">
              <span class="details-label">Cantidad:</span>
              <span class="details-value">{{ venta.cantidad }} unidad{% if venta.cantidad != 1 %}es{% endif %}</span>
            </div>
            <div class="details-row">
              <span class="details-label">Precio unitario:</span>
              <span class="details-value">{{ venta.producto_precio|format_cop }}</span>
            </div>
            <div class="details-row">
              <span class="details-label">Subtotal de línea:</span>
              <span class="details-value" style="color: #F39C12; font-weight: bold;">{{ venta.subtotal|format_cop }}</span>
            </div>
            <div class="details-row">
              <span class="details-label">Total del pedido:</span>
              <span class="details-value" style="color: #27AE60; font-weight: bold;">{{ venta.total_venta|format_cop }}</span>
            </div>
          </div>

        </div>
      {% endfor %}

    </div>

  {% else %}
    <div class="no-sales">
      <h2>No tienes ventas registradas aún</h2>
      <p>Cuando vendas productos, aparecerán aquí con todos los detalles.</p>
      <a href="{% url 'catalog' %}">Explorar Catálogo</a>
    </div>
  {% endif %}

</main>


<footer class="footer">
  <ul class="social-icon">
    <li class="icon-elem">
      <a href="https://www.youtube.com/@ArtesanoMarket-06" class="icon"><ion-icon name="logo-youtube"></ion-icon></a>
    </li>
    <li class="icon-elem">
      <a href="https://www.instagram.com/artek__06/" class="icon"><ion-icon name="logo-instagram"></ion-icon></a>
    </li>
    <li class="icon-elem">
      <a href="https://wa.me/573009688222?text=Hola,%20quiero%20más%20información" class="icon"><ion-icon name="logo-whatsapp"></ion-icon></a>
    </li>
    <li class="icon-elem">
      <a href="https://www.facebook.com/profile.php?id=61584617440121" class="icon"><ion-icon name="logo-facebook"></ion-icon></a>
    </li>
    <li class="icon-elem">
      <a href="https://mail.google.com/mail/?view=cm&fs=1&to=artesanomarkett@gmail.com" class="icon"><ion-icon name="mail-outline"></ion-icon></a>
    </li>
  </ul>

    <ul class="menu-footer">
        <li class="menu-elem"><a href="{% url 'dashboard_seller' %}" class="menu-icon-footer">Inicio</a></li>
        <li class="menu-elem"><a href="{% url 'seller_settings' %}" class="menu-icon-footer">Configuración</a></li>

        {% if request.session.user_id %}
        <li class="menu-elem">
            <form id="logout-form-footer" action="{% url 'auth_logout' %}" method="post" style="display:none;">
                {% csrf_token %}
            </form>
            <a href="#" class="menu-icon-footer"
               onclick="event.preventDefault(); document.getElementById('logout-form-footer').submit();">
                Cerrar Sesión
            </a>
        </li>
        {% endif %}

        <li class="menu-elem"><a href="{% url 'help' %}" class="menu-icon-footer">Contáctanos</a></li>
    </ul>

    <p class="text-footer">2025 | Todos los derechos reservados</p>
</footer>

<script src="{% static 'assets/js/scripts.js' %}"></script>
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>


<script>
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.btn-expandir').forEach(function(btn){
      btn.addEventListener('click', function(){
        var idx = this.dataset.sale;
        var panel = document.getElementById('details-' + idx);

        if (panel.style.display === 'none'){
          panel.style.display = 'block';
          this.textContent = 'Ocultar detalles';
        } else {
          panel.style.display = 'none';
          this.textContent = 'Ver detalles';
        }
      });
    });
  });
</script>

</body>
</html>
